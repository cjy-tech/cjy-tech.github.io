# 배치 작업

## 서비스 운영을 하면서 배치를 돌려야 하는 경우가 발생

* crontab 으로 스크립트 실행
* spring batch
* jenkins job
* ...

등등 각각의 환경에 맞게 배치를 실행한다
<br>
### 여기서는 crontab이 지원하는 실행 주기보다 잦은 간격으로 배치를 실행 해야 할때에 대해 다뤄본다

# crontab

* 최소 분단위까지만 주기적으로 실행할 수 있다

# svscan

* svscan은 서비스들을 시작하고 감시한다.
* 최소 1초 단위로 주기적 실행 가능
* 같은 service는 중복 실행 되지 않음

## 사용법

### daemontools 를 설치해야 한다

* svscan의 기본 path는 `/etc/service`
* svscan은 기본 path의 하위 디렉토리에 있는 supervise 프로세스를 시작
    * 1000개의 하위 디렉토리로 제한
* svscan은 .(점)으로 시작하는 하위 디렉토리는 무시
* svscan은 매 5초마다 하위 디렉토리를 확인
    * 새로운 하위 디렉토리를 발견하면, 새로운 supervise 프로세스를 자동 시작

### supervise

supervise는 서비스를 시작하고 감시한다.

사용법
<br>
```
supervise 서비스명
```

* supervise는 서비스명 디렉토리의 `./run` 을 시작
    * `./run이` 종료되면 `./run`을 재시작
    * `./run`이 곧바로 종료할 경우
        * 1초후 재실행
* 만약 `./down` 파일이 존재할 경우
    * `./run`를 바로 시작하지 않는다.
    * 경우에 맞게 `./run`을 수동으로 재시작 할 수 있다
* supervise는 하위디렉토리 안에 필요한 파일이 없거나 다른 supervise가 이미 실행되고 있다면 시작 즉시 종료
* supervise는 중지 명령어 실행하지 않는한 종료되지 않고 계속 실행된다.

### svc

svc는 supervise에 의해 감시되는 서비스를 제어한다.

사용법
<br>
```
svc opts services
```

* opts : 선택사항
* services : supervise에 의해 사용되는 디렉토리 명
* option
    * -u: 시작. 서비스가 실행되고 있지 않다면 시작, 서비스가 중지되어 있다면 재시작.
    * -d: 중지. 서비스가 실행중 이라면 TERM 신호를 보낸 후 CONT 신호를 보냄. 서비스가 중지되면 재시작 하지 않음.
    * -o: 한번만 실행하기. 서비스가 실행되고 있지 않다면 시작하고 중지되면 재시작 하지 않음.
    * -p : 정지 시키기. 서비스에 STOP 신호 보냄.
    * -c : 계속하기. 서비스에 CONT 신호 보냄.
    * -h : Hangup. 서비스에 HUP 신호 보냄.
    * -a : Alarm. 서비스에 ALRM 신호 보냄.
    * -i : Interrupt. 서비스에 INT 신호 보냄.
    * -t : Terminate. 서비스에 TERM 신호 보냄.
    * -k : Kill. 서비스에 KILL 신호 보냄.
    * -x : Exit

## 사용 예제

* `/etc/service` 하위 디렉토리에 `test` 디렉토리 생성
* test 디렉토리 안에 `run.tmp` 파일 생성
* run.tmp 파일을 열고 아래 스크립트 추가

```
#! /bin/sh

date >> /tmp/date.log
```

* `run.tmp -> run` 으로 이름변경
    * run 파일을 바로 인식하므로 스크립트 로직 편집중에 실행되는 것을 막음
* `tail -f /tmp/date.log` 로 1초간격으로 시간이 찍히는것 확인가능

### 서비스 중지

* `svc -d /etc/service/test`

## 응용

* 1초 말고 다른 주기로 실행을 하고자 한다면
    * 스크립트 내에 필요한 시간만큼의 sleep 을 주어 스크립트 구동 시간을 늦춘다

```
 #! /bin/sh

date >> /tmp/date.log

// 5초 간격으로 배치 실행됨
sleep 5
```

* 항상 실행되어 있는 상태로 있어야 하는 스크립트 (ex. listener 형식)
    * contab으로 등록한 경우 스크립트가 죽으면 최대 1분을 기다려야 함
    * svscan 으로 등록해 놓으면 1초 안에 재실행 됨